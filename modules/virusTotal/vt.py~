import requests
import json

# In case of checking multiple ioc (IP, domain or URL)
# class IOC:
#     def __init__(self, ioc_type, ioc):
#         self.ioc_type = ioc_type
#         self.ioc = ioc


def query_vt_apiv3(ip, key):
    headers = {
        "accept": "application/json",
        "x-apikey": key
    }

    # if ioc.ioc_type == "ip":
    #     url = "https://www.virustotal.com/api/v3/ip_addresses/" + ioc.ioc

    # elif ioc.ioc_type == "domain":
    #     url = "https://www.virustotal.com/api/v3/domains/"+ioc.ioc
    # elif ioc.ioc_type == "url":
    #     url = "https://www.virustotal.com/api/v3/urls/"+ioc.ioc

    url = "https://www.virustotal.com/api/v3/ip_addresses/" + ip
    response = requests.get(url, headers=headers)
    return json.loads(response.text)

def interpret_response(response):
    data = response["data"]
    attributes = data["attributes"]
    last_analysis_stats = attributes["last_analysis_stats"]
    harmless = last_analysis_stats["harmless"]
    malicious = last_analysis_stats["malicious"]
    undetected = last_analysis_stats["undetected"]
    total = harmless + malicious + undetected
    #print(data["data"]["attributes"]["last_analysis_stats"])
    #print("score = ", malicious,"/", total)
    return malicious


def main(ip, key):
    report = query_vt_apiv3(ip, key)
    return interpret_response(report)


# Example of IP checking
# Ioc = IOC("ip", "104.156.150.162")
# Ioc_report = query_vt_apiv3(Ioc)
# print(interpret_response(Ioc_report))
